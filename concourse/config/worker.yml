#cloud-config
package_update: true
packages:
  - curl
  - python
write_files:
  - path: "/concourse/keys/worker/tsa_host_key.pub"
    permissions: "0644"
    owner: "root"
    encoding: base64
    content: ${base64encode(pub_tsa_host_key)}
  - path: "/concourse/keys/worker/worker_key"
    permissions: "0644"
    owner: "root"
    encoding: base64
    content: ${base64encode(worker_key)}
  - path: "/concourse/keys/worker/worker_key.pub"
    permissions: "0644"
    owner: "root"
    encoding: base64
    content: ${base64encode(pub_worker_key)}
  - path: "/etc/rsyslog.d/concourse.conf"
    permissions: "0644"
    owner: "root"
    content: |
      if $programname == 'concourse' then /var/log/concourse.log
      if $programname == 'concourse' then ~
  - path: "/var/awslogs/config/template.conf"
    permissions: "0644"
    owner: "root"
    content: |
      [general]
      state_file = /var/awslogs/state/agent-state

      [/var/log/concourse.log]
      file = /var/log/concourse.log
      log_group_name = ${log_group_name}
      log_stream_name = {instance_id}
      datetime_format = %b %d %H:%M:%S
  - path: "/etc/systemd/system/awslogs.service"
    permissions: "0644"
    owner: "root"
    content: |
      [Unit]
      Description=Service for CloudWatch Logs agent
      After=rc-local.service

      [Service]
      Type=simple
      Restart=always
      KillMode=process
      TimeoutSec=infinity
      PIDFile=/var/awslogs/state/awslogs.pid
      ExecStart=/var/awslogs/bin/awslogs-agent-launcher.sh --start --background --pidfile $PIDFILE --user awslogs --chuid awslogs &amp;

      [Install]
      WantedBy=multi-user.target
  - path: "/etc/systemd/system/concourse.service"
    permissions: "0644"
    owner: "root"
    content: |
      [Unit]
      Description=Service for Concourse Worker
      Requires=network-online.target
      After=network-online.target

      [Service]
      Restart=always
      RestartSec=30s
      TimeoutStartSec=5m
      StandardOutput=syslog
      StandardError=syslog
      SyslogIdentifier=concourse

      Environment="CONCOURSE_BIND_IP=0.0.0.0"
      Environment="CONCOURSE_WORK_DIR=/concourse"
      Environment="CONCOURSE_TSA_HOST=${concourse_tsa_host}"
      Environment="CONCOURSE_BAGGAGECLAIM_BIND_IP=0.0.0.0"
      Environment="CONCOURSE_BAGGAGECLAIM_LOG_LEVEL=${log_level}"
      Environment="CONCOURSE_TSA_PUBLIC_KEY=/concourse/keys/worker/tsa_host_key.pub"
      Environment="CONCOURSE_TSA_WORKER_PRIVATE_KEY=/concourse/keys/worker/worker_key"
      ExecStartPre=/bin/bash -c "/bin/systemctl set-environment CONCOURSE_PEER_IP=$(curl -L http://169.254.169.254/latest/meta-data/local-ipv4)"
      ExecStart=/usr/local/bin/concourse worker

      [Install]
      WantedBy=multi-user.target
runcmd:
  - |
    curl https://s3.amazonaws.com/aws-cloudwatch/downloads/latest/awslogs-agent-setup.py -O
    chmod +x awslogs-agent-setup.py
    ./awslogs-agent-setup.py --non-interactive --region eu-west-1 --configfile=/var/awslogs/config/template.conf
  - |
    curl -L "${concourse_download_url}" > /usr/local/bin/concourse
    chmod 0755 /usr/local/bin/concourse
    chown root:root /usr/local/bin/concourse
  - |
    systemctl enable awslogs.service --now
    systemctl enable concourse.service --now
