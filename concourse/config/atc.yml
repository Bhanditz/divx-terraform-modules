#cloud-config
package_update: true
packages:
  - curl
  - python
write_files:
  - path: "/concourse/keys/web/tsa_host_key"
    permissions: "0644"
    owner: "root"
    encoding: base64
    content: ${base64encode(tsa_host_key)}
  - path: "/concourse/keys/web/session_signing_key"
    permissions: "0644"
    owner: "root"
    encoding: base64
    content: ${base64encode(session_signing_key)}
  - path: "/concourse/keys/web/authorized_worker_keys"
    permissions: "0644"
    owner: "root"
    encoding: base64
    content: ${base64encode(authorized_worker_keys)}
  - path: "/usr/local/etc/systemd-cloudwatch-config"
    owner: "root"
    content: |
      aws_region   = "${log_group_region}"
      log_group    = "${log_group_name}"
  - path: "/etc/systemd/system/systemd-cloudwatch.service"
    permissions: "0644"
    owner: "root"
    content: |
      [Unit]
      Description=Service for systemd-cloudwatch
      Wants=basic.target
      After=basic.target network.target

      [Service]
      Restart=always
      RestartSec=30s
      KillMode=process
      ExecStart=/usr/local/bin/systemd-cloudwatch /usr/local/etc/systemd-cloudwatch-config
  - path: "/etc/systemd/system/concourse.service"
    permissions: "0644"
    owner: "root"
    content: |
      [Unit]
      Description=Service for Concourse ATC/TSA
      Requires=network-online.target
      After=network-online.target

      [Service]
      Restart=always
      RestartSec=30s
      TimeoutStartSec=5m
      Environment="CONCOURSE_GITHUB_AUTH_CLIENT_ID=${github_client_id}"
      Environment="CONCOURSE_GITHUB_AUTH_CLIENT_SECRET=${github_client_secret}"
      Environment="CONCOURSE_GITHUB_AUTH_USER=${github_users}"
      Environment="CONCOURSE_POSTGRES_DATA_SOURCE=${concourse_postgres_source}"
      Environment="CONCOURSE_EXTERNAL_URL=${concourse_web_host}"
      Environment="CONCOURSE_LOG_LEVEL=${log_level}"
      Environment="CONCOURSE_TSA_LOG_LEVEL=${log_level}"
      Environment="CONCOURSE_VAULT_URL=${vault_url}"
      Environment="CONCOURSE_VAULT_CLIENT_TOKEN=${vault_client_token}"
      Environment="CONCOURSE_TSA_HOST_KEY=/concourse/keys/web/tsa_host_key"
      Environment="CONCOURSE_TSA_AUTHORIZED_KEYS=/concourse/keys/web/authorized_worker_keys"
      Environment="CONCOURSE_SESSION_SIGNING_KEY=/concourse/keys/web/session_signing_key"
      Environment="CONCOURSE_ENCRYPTION_KEY=${encryption_key}"
      Environment="CONCOURSE_OLD_ENCRYPTION_KEY=${old_encryption_key}"
      ExecStartPre=/bin/bash -c "/bin/systemctl set-environment CONCOURSE_PEER_URL=http://$(curl -L http://169.254.169.254/latest/meta-data/local-ipv4):8080"
      ExecStart=/usr/local/bin/concourse web

      [Install]
      WantedBy=multi-user.target
runcmd:
  - |
    curl -L "${systemd_cloudwatch_download_url}" > /usr/local/bin/systemd-cloudwatch
    chmod 0755 /usr/local/bin/systemd-cloudwatch
    chown root:root /usr/local/bin/systemd-cloudwatch
  - |
    curl -L "${concourse_download_url}" > /usr/local/bin/concourse
    chmod 0755 /usr/local/bin/concourse
    chown root:root /usr/local/bin/concourse
  - |
    systemctl enable systemd-cloudwatch.service --now
    systemctl enable concourse.service --now
